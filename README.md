# HotelBookingInformationSystem
Проект демонстрируюет полный цикл разработки: от проектировани бд, до развертывания, снятия метрик и администрирования.

Платформа хранит, моделирует и анализирует данные о бронировании отелей (партнеры, отели, номера, удобства, пользователи, бронирования, платежи, бонусные счета и история аудита) и работает на высокодоступном кластере PostgreSQL с автоматизированными миграциями, сидами, нагрузочным тестированием, мониторингом и запланированным резервным копированием.

Проект реализован в 4 этапа:

- Подготовка и проектирование (функциональные требования, проектирование схемы бд и построение ER диограммы) [FunctionalRequirements.md](FunctionalRequirements.md)
- Развертывание (развертывание бд, создание миграций, сидирование бд, и создание ролей)
- Администрирование, оптимизация и мониторинг (устновка систем мониторинга и сбор метрик, написание сервиса иметирующего работу с нашим сервисом, добавление идексов, создание бэкапов бд, развертывание 3 реплик Postgres для отказоустойчивости кластера)
- Тестирование миграций (релизован миханизм тестирования миграций)
## Использование проекта и его жизненный цикл
Создайте и настройте файлы `.env` и `patroni.env`

Для запуска проекта с мониторингом и нагрузочным тестированим используйте:

```bash
docker compose --profile seed --profile monitor --profile load up -d
```

После запуска выполняются следующие действия:

1. Поднимается кластер Etcd
2. Запуск 3 реплик Patroni сPostgreSQL и выбирается мастер. 
3. HAProxy балансирует нагрузку на кластер, опредляе текушего мастера и реплики.
4. Проверка миграций на идемпотентность
5. Если миграции идемпотентны, Flyway применяет миграции до актуальной версии схемы.
7. В рамках миграций: Создание роли групповой роли analytic с возможностью читать, но не изменять данные в отношениях и n-ое кол-во пользователей, и унаследованных роль от analytic.
6. При профеле `seed` заполнение бд тестовыми данными с помощью: Python и Faker.
8. При профеле `monitor`: 

    Запуск PgExporter, Prometheus, Grafana для мониторинга.

    Запуск сервиса имитирующий работу с сервисом.
10. При профеле `db_backup` запускается крон задача, которая создавает бэкапы базы данных.

## Использованные технологии и инструменты

- **Docker & Docker Compose** – контейнеризация и настройка сервисов проекта.
- **PostgreSQL** – СУБД для хранения данных.
- **Patroni + etcd** – автоматическая репликация PostgreSQL, обеспечение работы кластера.
- **HAProxy** – балансировка запросов к кластеру.
- **Flyway** – автоматические миграции базы данных.
- **Python + Faker** – генерация реалистичных тестовых данных.
- **Python + Prometheus_client** - loadtest сервис имитурющий рабрту с сервисом проекта.
- **PgExporter** - сбор метрик с PostgreSQL.
- **Prometheus** – единый источник метрик, собирает данные с PgExporter и loadtest.
- **Grafana** – визуализация собранных метрик и состояния системы.
- **Резервное копирование** – регулярное создание дампов базы данных с очисткой старых копий.
- **Bash** - тест идемпотентности.

## Структура репозитория

```sh
└── HotelBookingInformationSystem/
    ├─ FunctionalRequirements.md # Функциональные требования и ER диограммы
    ├─ docker-compose.yml # Основной Docker Compose-файл
    ├─ migrations/ # Flyway-миграции
    ├─ seeder/ # Сидирование бд
    ├─ loadtest/ # Скрипты для нагрузочного тестирования
    ├─ monitor/ 
    │   ├─ prometheus.yml # Конфигурация Prometheus
    │   ├─ pg-exporter/ # Конфигурация pg-exporter
    │   └─ grafana/ # Конфигурация Grafana и дашборды
    ├─ backups/ #Скрипт для резервного копирования базы данных
    ├─ idempotency/ # Скрипт для проверки идемпотентности миграций
    ├─ .env # Шаблон файла переменных окружения
    ├── haproxy.cfg # Конфигурация haproxy
    ├── Dockerfile.haproxy
    └── patroni.env # Шаблон файла переменных окружения для patroni
```